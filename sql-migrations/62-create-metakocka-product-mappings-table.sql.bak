-- Create metakocka_product_mappings table
BEGIN;

-- This table maps products in our CRM to products in Metakocka
CREATE TABLE IF NOT EXISTS metakocka_product_mappings (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    product_id UUID NOT NULL REFERENCES products(id) ON DELETE CASCADE,
    metakocka_id VARCHAR(255) NOT NULL,
    metakocka_code VARCHAR(255),
    last_synced_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    sync_status VARCHAR(50) NOT NULL DEFAULT 'synced',
    sync_error TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    user_id UUID NOT NULL REFERENCES auth.users(id),
    
    -- Ensure each product can only be mapped once per user
    CONSTRAINT unique_product_mapping UNIQUE (product_id, user_id),
    
    -- Ensure each Metakocka product can only be mapped once per user
    CONSTRAINT unique_metakocka_mapping UNIQUE (metakocka_id, user_id)
);

-- Add RLS policies
ALTER TABLE metakocka_product_mappings ENABLE ROW LEVEL SECURITY;

-- Policy for select: users can only see their own mappings
CREATE POLICY select_metakocka_product_mappings ON metakocka_product_mappings
    FOR SELECT USING (user_id = auth.uid());

-- Policy for insert: users can only insert their own mappings
CREATE POLICY insert_metakocka_product_mappings ON metakocka_product_mappings
    FOR INSERT WITH CHECK (user_id = auth.uid());

-- Policy for update: users can only update their own mappings
CREATE POLICY update_metakocka_product_mappings ON metakocka_product_mappings
    FOR UPDATE USING (user_id = auth.uid());

-- Policy for delete: users can only delete their own mappings
CREATE POLICY delete_metakocka_product_mappings ON metakocka_product_mappings
    FOR DELETE USING (user_id = auth.uid());

-- Add indexes for performance
CREATE INDEX IF NOT EXISTS idx_metakocka_product_mappings_product_id ON metakocka_product_mappings(product_id);
CREATE INDEX IF NOT EXISTS idx_metakocka_product_mappings_metakocka_id ON metakocka_product_mappings(metakocka_id);
CREATE INDEX IF NOT EXISTS idx_metakocka_product_mappings_user_id ON metakocka_product_mappings(user_id);

-- Add trigger for updated_at
CREATE TRIGGER set_metakocka_product_mappings_updated_at
BEFORE UPDATE ON metakocka_product_mappings
FOR EACH ROW
EXECUTE FUNCTION trigger_set_timestamp();

COMMIT;
